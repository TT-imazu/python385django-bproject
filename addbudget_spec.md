# addbudget 仕様書

## 1. 画面構成

### 1.1 全体レイアウト
- 画面は3カラム構成
  - 左カラム: 予算データ表示・編集エリア（スクロール可能）
  - 中央カラム: 連結情報表示エリア
  - 右カラム: 銀行データ表示エリア（スクロール可能）

### 1.2 ヘッダー部分（常時表示）
- 年月選択（YYYYMM形式）
- 口座コード選択
- 期間（DateRange）選択
- 日付指定（数値入力）
- 連結ありのみ表示フラグ（チェックボックス）
- 変更ボタン
- アコーディオン操作ボタン
  - 「すべて開く」ボタン
  - 「すべて閉じる」ボタン

## 2. アコーディオン機能

### 2.1 階層構造
```
DateRange（期間）
├── 入金セクション（青系統）
│   ├── 工事金入金
│   │   ├── 未連携データ（常時表示）
│   │   └── 連携済データ（アコーディオン）
│   └── その他入金
│       ├── 未連携データ（常時表示）
│       └── 連携済データ（アコーディオン）
├── 出金セクション（赤系統）
│   ├── 自動引落
│   │   ├── 未連携データ（常時表示）
│   │   └── 連携済データ（アコーディオン）
│   └── 個別支払
│       ├── 未連携データ（常時表示）
│       └── 連携済データ（アコーディオン）
└── 預金振替セクション（黄系統）
    ├── 未連携データ（常時表示）
    └── 連携済データ（アコーディオン）
```

### 2.2 色の仕様

#### 入金セクション（青系統）
- セクションヘッダー: `#b3e5fc`（薄い青）
- 工事金入金
  - サブヘッダー: `#d9efff`（より薄い青）
  - 未連携データ背景: `#eef6fc`（最も薄い青）
- その他入金
  - サブヘッダー: `#e0f7f4`（薄い水色）
  - 未連携データ背景: `#f1fcfa`（最も薄い水色）

#### 出金セクション（赤系統）
- セクションヘッダー: `#ffccbc`（薄い赤）
- 自動引落
  - サブヘッダー: `#ffe8d6`（薄いオレンジ）
  - 未連携データ背景: `#fdf3eb`（最も薄いオレンジ）
- 個別支払
  - サブヘッダー: `#ffd9eb`（薄いピンク）
  - 未連携データ背景: `#fdecf4`（最も薄いピンク）

#### 預金振替セクション（黄系統）
- セクションヘッダー: `#f4f1de`（薄い黄）
- 未連携データ背景: `#fdfcf3`（最も薄い黄）

### 2.3 常時表示される要素
- 各セクションのヘッダー
- 未連携データのテーブル
- 合計金額表示行
- 新規追加ボタン

### 2.4 アコーディオン動作
- 開閉状態はローカルストレージに保存
- アイコン表示
  - 開いている状態: ▲
  - 閉じている状態: ▼
- クリックで個別開閉可能
- 「すべて開く」「すべて閉じる」で一括操作可能

## 3. ドラッグアンドドロップ機能

### 3.1 ドラッグ可能な要素
- 右カラムの銀行データ
  - 入金データ
  - 出金データ

### 3.2 ドロップ可能な領域
- 工事金入金（入金データのみ）
- その他入金（入金データのみ）
- 自動引落（出金データのみ）
- 個別支払（出金データのみ）
- 預金振替（入金・出金データ両方）

### 3.3 ドロップ時の処理
1. 取引種別の検証
   - 入金データは入金セクションのみ
   - 出金データは出金セクションのみ
   - 預金振替は両方可能

2. 連携済みデータのチェック
   - 既に連携済みのデータはドロップ不可
   - エラーメッセージを表示

3. データ作成処理
   - Budgetレコードの新規作成
   - 連携番号（UUID）の生成
   - Connectテーブルへの登録
   - ConnectDetailテーブルへの登録
   - BankDataとBudgetの連携

4. 画面更新
   - 成功時: 画面をリロード
   - 失敗時: エラーメッセージを表示

### 3.4 制限事項
- 連携済みデータは再度ドロップ不可
- 取引種別が一致しない場合はドロップ不可
- 預金振替の出金データは自動的に金額をマイナスに変換

## 4. その他の機能

### 4.1 データ編集
- 金額の直接編集
- 並び順（sort_no1, sort_no2）の編集
- 項目の削除（未連携データのみ可能）

### 4.2 連携解除
- 連携済みデータの解除ボタン
- 解除時は関連するConnect, ConnectDetailも削除

### 4.3 新規追加
- 各セクションの新規追加ボタン
- 手動で項目を追加可能
- 保存ボタンで一括保存

## 5. 画面更新の仕様

### 5.1 更新が発生する操作
1. データ保存時
   - 一括保存ボタン押下時
   - 各項目の編集後

2. ドラッグ＆ドロップ時
   - 銀行データのドロップ成功時
   - 連携処理完了時

3. 設定変更時
   - 年月変更時
   - 口座コード変更時
   - 期間（DateRange）変更時
   - 日付指定変更時
   - 連結ありのみ表示フラグ変更時

4. データ削除時
   - 項目削除時
   - 連携解除時

### 5.2 更新内容
1. データ表示の更新
   - 予算データの再取得と表示
   - 銀行データの再取得と表示
   - 合計金額の再計算と表示

2. 連携状態の更新
   - 連携済みデータの表示更新
   - 未連携データの表示更新

3. 残高計算の更新
   - 各期間の残高見込の再計算
   - 合計金額の再計算

### 5.3 更新方法
1. 自動更新
   - ドラッグ＆ドロップ成功時
   - 連携解除時
   - 項目削除時
   - 設定変更時

2. 手動更新
   - 一括保存ボタン押下時
   - 各項目の編集後

### 5.4 エラー処理
1. 更新失敗時
   - エラーメッセージの表示
   - 前回の表示状態の維持

2. データ不整合時
   - 警告メッセージの表示
   - 整合性チェックの実行 