{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>äºˆç®—é›†è¨ˆ</title>
    <style>
        /* å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ã‚°ãƒªãƒƒãƒ‰ã«å¤‰æ›´ã—ã€ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ */
        .container {
            display: grid;
            grid-template-columns: 0.4fr 0.2fr 0.4fr; /* å·¦:ã‚„ã‚„ç‹­ã‚, ä¸­å¤®:åºƒã‚, å³:ã‚„ã‚„ç‹­ã‚ */
            gap: 20px;
            width: 100%;
            min-height: 90vh;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…±é€šãƒ‡ã‚¶ã‚¤ãƒ³ */
        .side-table-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff; 
            padding: 10px;
        }

        /* ä¸­å¤®ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
        .scrollable {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #f9f9f9;
            padding: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* å°ã•ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆä»Šå›ã®ä¾‹ã§ã¯ä½¿ã£ã¦ã„ãªã„ãªã‚‰å‰Šé™¤å¯ï¼‰ */
        .mini-table-container {
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #fff;
            padding: 10px;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }

        /* å¼·èª¿è¡¨ç¤º(ãƒã‚¤ãƒ©ã‚¤ãƒˆ)ã®è‰²ã‚’å°‘ã—æŠ‘ãˆã‚ã« */
        .highlight {
            background-color: #fffae0; /* è–„ã„é»„è‰² */
        }
        .blue-highlight {
            background-color: #eaf3ff; /* è–„ã„æ°´è‰² */
        }
        .blue2-highlight {
            background-color: #e0f9e0; /* è–„ã„ç·‘è‰² */
        }

        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ•´ãˆã‚‹ */
        .add-button {
            background-color: #007BFF; 
            border: none;
            color: white;
            padding: 8px 16px;
            margin: 4px 2px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        .add-button:hover {
            background-color: #0056b3;
        }

        /* æ•°å­—ç”¨ã®å³å¯„ã›ãªã© */
        .text-right {
            text-align: right;
        }
        .text-left {
            text-align: left;
        }
        input[type="number"] {
            width: 80px;
        }

        /* ãƒœãƒ¼ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .no-border td, .no-border th {
            border: none;
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† */
        .accordion-header {
            cursor: pointer;
            background-color: #e1e1e1;
            font-weight: bold;
        }
        .accordion-header:hover {
            background-color: #ccc;
        }
        .accordion-icon {
            float: right;
            margin-right: 10px;
        }
        /* æŠ˜ã‚ŠãŸãŸã¿ç”¨ */
        .hidden {
            display: none;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—å¹…èª¿æ•´ */
        table col.date-col { width: 5%; }  /* æ—¥ä»˜ */
        table col.number-col { width: 5%; } /* ç•ªå· */
        table col.ammount-col { width: 30%; } /* å®Ÿéš› */
        table col.name-col { width: 45%; } /* ç›¸æ‰‹å…ˆã¯è‡ªå‹•èª¿æ•´ */
        table col.connect-col { width: 15%; } /* é€£çµ */
        
        /* éŠ€è¡Œãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .bank-data-cell {
            padding: 5px;
            min-height: 60px;
            vertical-align: top;
        }
        .bank-data-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
        }
        .bank-data-item.income {
            background-color: #e8f5e9; /* å…¥é‡‘ã¯è–„ã„ç·‘ */
        }
        .bank-data-item.withdrawal {
            background-color: #ffebee; /* å‡ºé‡‘ã¯è–„ã„èµ¤ */
        }
        .bank-data-amount {
            font-weight: bold;
            text-align: right;
        }
        .unlink-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 3px;
        }
        .unlink-button:hover {
            background-color: #d32f2f;
        }

        /* å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 3px;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>


<!-- éš ã—è¦ç´ ã¨ã—ã¦ amount_fundtrans ã‚’è¨­å®š (ç”»é¢ã«ã¯è¡¨ç¤ºã—ãªã„) -->
<input type="hidden" id="amount_fundtrans" value="{{ amount_fundtrans }}">

<!-- å¹´æœˆ & å£åº§é¸æŠãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="POST" action="{% url 'addbudget' %}">
    {% csrf_token %}
    <label>è¡¨ç¤ºå¹´æœˆ (YYYYMM): </label>
    <input type="text" name="year_month" value="{{ year_month }}">

    <label>å£åº§ã‚³ãƒ¼ãƒ‰:</label>
    <select name="account_code_id">
        <option value="">-- æœªé¸æŠ --</option>
        {% for ac in account_codes %}
            <option value="{{ ac.id }}"
                {% if selected_account_code and ac.id == selected_account_code.id %}
                    selected
                {% endif %}
            >
                {{ ac.bank_code }} / {{ ac.deposit_type }} / {{ ac.account_number }}
            </option>
        {% endfor %}
    </select>

    <!-- â˜… ã“ã“ã« DateRange ã®é¸æŠã‚’è¿½åŠ  -->
    <label>æœŸé–“ (DateRange):</label>
    <select name="daterange_id">
        <option value="">-- æœªé¸æŠ --</option>
        {% for dr in date_ranges_all %}
            <option value="{{ dr.id }}"
                {% if user_settings.selected_daterange and dr.id == user_settings.selected_daterange.id %}
                    selected
                {% endif %}
            >
                {{ dr.name }} ({{ dr.start_day }}ï½{{ dr.end_day }})
            </option>
        {% endfor %}
    </select>

    <!-- æ—¥ä»˜ã®ä¸Šé™ (end_day) -->
    <label>æ—¥ä»˜æŒ‡å®š:</label>
    <input type="number" name="end_day" value="{{ user_settings.end_day }}" style="width:80px;">

    <!-- é€£çµãƒ•ãƒ©ã‚° (connectflag) -->
    <label>é€£çµã‚ã‚Šã®ã¿?</label>
    <input type="checkbox" name="connectflag" value="1"
        {% if user_settings.connectflag %} checked {% endif %}>

    <button type="submit">å¤‰æ›´</button>
</form>

<button onclick="openAllAccordions()">ã™ã¹ã¦é–‹ã</button>
<button onclick="closeAllAccordions()">ã™ã¹ã¦é–‰ã˜ã‚‹</button>

<hr>

<div class="container">

    <!-- å·¦ã‚«ãƒ©ãƒ  (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«) -->
    <div class="scrollable scrollable-left">
        <!-- äºˆç®—ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ  (æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ãƒ»æ–°è¦è¿½åŠ ) -->
        <form method="post" action="{% url 'addbudget' %}">
            {% csrf_token %}
            <!-- year_month ã¨ account_code_id ã‚’ hidden ã§å†åº¦æŒãŸã›ã‚‹ -->
            <input type="hidden" name="year_month" value="{{ year_month }}">
            <input type="hidden" name="account_code_id" value="{% if selected_account_code %}{{ selected_account_code.id }}{% endif %}">

            <table>
                <tr>
                    <td colspan="1">å‰æœˆæ®‹é«˜</td>
                    <td class="text-right">{{ initial_prev_balance }}</td>
                </tr>
            </table>
            <a>&nbsp;</a>

            {% for dr, data in budget_data.items %}
            <h2 class="accordion-header" data-target="date_range_{{ dr.id }}">
                {{ dr.name }}
                <span class="accordion-icon">â–¼</span>
            </h2>
            <table id="date_range_{{ dr.id }}" class="hidden">


                <!-- å…¥é‡‘ (å·¥äº‹é‡‘å…¥é‡‘, ãã®ä»–å…¥é‡‘) -->
                <tr class="blue-highlight">
                    <th colspan="5" class="text-left" style="background-color:#b3e5fc;">ã€ å…¥ é‡‘ ã€‘</th>
                </tr>

                <tr class="highlight no-border">
                    <th colspan="5" class="text-left" style="background-color:#d9efff;">= å·¥äº‹é‡‘å…¥é‡‘ =</th>
                </tr>
                <colgroup>
                    <col class="name-col">
                    <col class="date-col">
                    <col class="number-col">
                    <col class="ammount-col">
                    <col class="connect-col">
                </colgroup>                
                <tr class="blue2-highlight">
                    <th>ç›¸æ‰‹å…ˆ</th>
                    <th>æ—¥ä»˜</th>
                    <th>ç•ªå·</th>
                    <th>è¦‹è¾¼/å®Ÿéš›</th>
                    <th>é€£çµ</th>
                </tr>

                <!-- æœªé€£æº(connected_numberãªã—)ãƒ‡ãƒ¼ã‚¿ -->
                <tbody id="insales_items_{{ dr.id }}"
                       ondrop="drop(event, '{{ dr.id }}', 'insales')"
                       ondragover="allowDrop(event)">
                    <!-- æ–°è¦ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ç”¨ -->
                    <tr>
                        <td colspan="5" style="text-align:center; background-color:#eef6fc;">
                            å·¥äº‹é‡‘å…¥é‡‘ã€€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        </td>
                    </tr>
                    {% with unconnected_insales=data.items.å·¥äº‹é‡‘å…¥é‡‘ %}
                    {% for item in unconnected_insales %}
                    {% if not item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no1_{{ item.id }}"
                                   value="{{ item.sort_no1 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no2_{{ item.id }}"
                                   value="{{ item.sort_no2 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="amount_{{ item.id }}"
                                   value="{{ item.amount }}"
                                   class="text-right"
                                   style="width:150px;">
                        </td>
                        <td>
                            <button class="delete-button" type="button" onclick="deleteBudgetItem('{{ item.id }}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% endwith %}
                </tbody>
                <tr class="accordion-header" data-target="connected_insales_{{ dr.id }}">
                    <td colspan="5" class="text-left" style="background-color:#d9efff;">
                        é€£æºæ¸ˆãƒ‡ãƒ¼ã‚¿(å·¥äº‹é‡‘å…¥é‡‘)
                        <span class="accordion-icon">â–¼</span>
                    </td>
                </tr>
                <tbody id="connected_insales_{{ dr.id }}" class="hidden">
                    {% for item in data.items.å·¥äº‹é‡‘å…¥é‡‘ %}
                    {% if item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td>{{ item.sort_no1 }}</td>
                        <td>{{ item.sort_no2 }}</td>
                        <td class="text-right">{{ item.amount }}</td>
                        <td>
                            <button class="unlink-button" type="button" onclick="unlinkConnection('{{ item.connected_number }}')">è§£é™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tr style="background-color:#d9efff;">
                    <td>=å·¥äº‹é‡‘å…¥é‡‘åˆè¨ˆ=</td>
                    <td colspan="4" class="text-right">{{ data.insales_total }}</td>
                </tr>



                <tr class="highlight no-border">
                    <th colspan="5" class="text-left" style="background-color:#e0f7f4;">= ãã®ä»–å…¥é‡‘ =</th>
                </tr>
                <colgroup>
                    <col class="name-col">
                    <col class="date-col">
                    <col class="number-col">
                    <col class="ammount-col">
                    <col class="connect-col">
                </colgroup>                
                <tr class="blue2-highlight">
                    <th>ç›¸æ‰‹å…ˆ</th>
                    <th>æ—¥ä»˜</th>
                    <th>ç•ªå·</th>
                    <th>è¦‹è¾¼/å®Ÿéš›</th>
                    <th>é€£çµ</th>
                </tr>

                <!-- æœªé€£æº(connected_numberãªã—)ãƒ‡ãƒ¼ã‚¿ -->
                <tbody id="inregular_items_{{ dr.id }}"
                       ondrop="drop(event, '{{ dr.id }}', 'inregular')"
                       ondragover="allowDrop(event)">
                    <!-- æ–°è¦ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ç”¨ -->
                    <tr>
                        <td colspan="5" style="text-align:center; background-color:#f1fcfa;">
                            ãã®ä»–å…¥é‡‘ã€€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        </td>
                    </tr>
                    {% with unconnected_inregular=data.items.ãã®ä»–å…¥é‡‘ %}
                    {% for item in unconnected_inregular %}
                    {% if not item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no1_{{ item.id }}"
                                   value="{{ item.sort_no1 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no2_{{ item.id }}"
                                   value="{{ item.sort_no2 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="amount_{{ item.id }}"
                                   value="{{ item.amount }}"
                                   class="text-right"
                                   style="width:150px;">
                        </td>
                        <td>
                            <button class="delete-button" type="button" onclick="deleteBudgetItem('{{ item.id }}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% endwith %}
                </tbody>
                <tr class="accordion-header" data-target="connected_inregular_{{ dr.id }}">
                    <td colspan="5" class="text-left" style="background-color:#e0f7f4;">
                        é€£æºæ¸ˆãƒ‡ãƒ¼ã‚¿(ãã®ä»–å…¥é‡‘)
                        <span class="accordion-icon">â–¼</span>
                    </td>
                </tr>
                <tbody id="connected_inregular_{{ dr.id }}" class="hidden">
                    {% for item in data.items.ãã®ä»–å…¥é‡‘ %}
                    {% if item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td>{{ item.sort_no1 }}</td>
                        <td>{{ item.sort_no2 }}</td>
                        <td class="text-right">{{ item.amount }}</td>
                        <td>
                            <button class="unlink-button" type="button" onclick="unlinkConnection('{{ item.connected_number }}')">è§£é™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tr  style="background-color:#e0f7f4;">
                    <td>=ãã®ä»–å…¥é‡‘åˆè¨ˆ=</td>
                    <td colspan="4" class="text-right">{{ data.inregular_total }}</td>
                </tr>



                <tr class="blue-highlight" style="background-color:#b3e5fc;">
                    <td>ã€å…¥é‡‘åˆè¨ˆã€‘</td>
                    <td colspan="4" class="text-right">{{ data.total_income }}</td>
                </tr>



                
                <!-- å‡ºé‡‘ (è‡ªå‹•å¼•è½, å€‹åˆ¥æ”¯æ‰•) -->
                <tr class="blue-highlight">
                    <th colspan="5" class="text-left" style="background-color:#ffccbc;">ã€ å‡º é‡‘ ã€‘</th>
                </tr>

                <!-- è‡ªå‹•å¼•è½ -->
                <tr class="no-border">
                    <th colspan="5" class="text-left" style="background-color:#ffe8d6;">è‡ªå‹•å¼•è½</th>
                </tr>
                <colgroup>
                    <col class="name-col">
                    <col class="date-col">
                    <col class="number-col">
                    <col class="ammount-col">
                    <col class="connect-col">
                </colgroup>                
                <tr class="blue2-highlight">
                    <th>ç›¸æ‰‹å…ˆ</th>
                    <th>æ—¥ä»˜</th>
                    <th>ç•ªå·</th>
                    <th>è¦‹è¾¼/å®Ÿéš›</th>
                    <th>é€£çµ</th>
                </tr>
                <tbody id="auto_items_{{ dr.id }}"
                       ondrop="drop(event, '{{ dr.id }}', 'auto')"
                       ondragover="allowDrop(event)">
                    <!-- æ–°è¦ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ç”¨ -->
                    <tr>
                        <td colspan="5" style="text-align:center; background-color:#fdf3eb;">
                            è‡ªå‹•å¼•è½ã€€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        </td>
                    </tr>
                    {% for item in data.items.è‡ªå‹•å¼•è½ %}
                    {% if not item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no1_{{ item.id }}"
                                   value="{{ item.sort_no1 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no2_{{ item.id }}"
                                   value="{{ item.sort_no2 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="amount_{{ item.id }}"
                                   value="{{ item.amount }}"
                                   class="text-right"
                                   style="width:150px;">
                        </td>
                        <td>
                            <button class="delete-button" type="button" onclick="deleteBudgetItem('{{ item.id }}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tr class="accordion-header" data-target="connected_auto_{{ dr.id }}">
                    <td colspan="5" class="text-left" style="background-color:#ffe8d6;">
                        é€£æºæ¸ˆãƒ‡ãƒ¼ã‚¿(è‡ªå‹•å¼•è½)
                        <span class="accordion-icon">â–¼</span>
                    </td>
                </tr>
                <tbody id="connected_auto_{{ dr.id }}" class="hidden">
                    {% for item in data.items.è‡ªå‹•å¼•è½ %}
                    {% if item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td>{{ item.sort_no1 }}</td>
                        <td>{{ item.sort_no2 }}</td>
                        <td class="text-right">{{ item.amount }}</td>
                        <td>
                            <button class="unlink-button" type="button" onclick="unlinkConnection('{{ item.connected_number }}')">è§£é™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tr style="background-color:#ffe8d6;">
                    <td>è‡ªå‹•å¼•è½åˆè¨ˆ</td>
                    <td colspan="4" class="text-right">{{ data.expense_auto_total }}</td>
                </tr>

                <!-- å€‹åˆ¥æ”¯æ‰• -->
                <tr class="no-border">
                    <th colspan="5" class="text-left"  style="background-color:#ffd9eb;">å€‹åˆ¥æ”¯æ‰•</th>
                </tr>
                <colgroup>
                    <col class="name-col">
                    <col class="date-col">
                    <col class="number-col">
                    <col class="ammount-col">
                    <col class="connect-col">
                </colgroup>                
                <tr class="blue2-highlight">
                    <th>ç›¸æ‰‹å…ˆ</th>
                    <th>æ—¥ä»˜</th>
                    <th>ç•ªå·</th>
                    <th>è¦‹è¾¼/å®Ÿéš›</th>
                    <th>é€£çµ</th>
                </tr>
                <tbody id="individual_items_{{ dr.id }}"
                       ondrop="drop(event, '{{ dr.id }}', 'individual')"
                       ondragover="allowDrop(event)">
                    <!-- æ–°è¦ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ç”¨ -->
                    <tr>
                        <td colspan="5" style="text-align:center; background-color:#fdecf4;">
                            å€‹åˆ¥æ”¯æ‰•ã€€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        </td>
                    </tr>
                    {% for item in data.items.å€‹åˆ¥æ”¯æ‰• %}
                    {% if not item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no1_{{ item.id }}"
                                   value="{{ item.sort_no1 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no2_{{ item.id }}"
                                   value="{{ item.sort_no2 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="amount_{{ item.id }}"
                                   value="{{ item.amount }}"
                                   class="text-right"
                                   style="width:150px;">
                        </td>
                        <td>
                            <button class="delete-button" type="button" onclick="deleteBudgetItem('{{ item.id }}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tr class="accordion-header" data-target="connected_individual_{{ dr.id }}">
                    <td colspan="5" class="text-left"  style="background-color:#ffd9eb;">
                        é€£æºæ¸ˆãƒ‡ãƒ¼ã‚¿(å€‹åˆ¥æ”¯æ‰•)
                        <span class="accordion-icon">â–¼</span>
                    </td>
                </tr>
                <tbody id="connected_individual_{{ dr.id }}" class="hidden">
                    {% for item in data.items.å€‹åˆ¥æ”¯æ‰• %}
                    {% if item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td>{{ item.sort_no1 }}</td>
                        <td>{{ item.sort_no2 }}</td>
                        <td class="text-right">{{ item.amount }}</td>
                        <td>
                                <button class="unlink-button" type="button" onclick="unlinkConnection('{{ item.connected_number }}')">è§£é™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>

                <tr class="blue-highlight" style="background-color:#ffd9eb;">
                    <td  style="background-color:#ffd9eb;">=å€‹åˆ¥æ”¯æ‰•åˆè¨ˆ=</td>
                    <td colspan="4" class="text-right">{{ data.expense_individual_total }}</td>
                </tr>
                <tr class="blue-highlight"  style="background-color:#ffccbc;">
                    <td>ã€å‡ºé‡‘åˆè¨ˆã€‘</td>
                    <td colspan="4" class="text-right">{{ data.total_expense }}</td>
                </tr>


                <tr class="highlight no-border">
                    <th colspan="5" class="text-left" style="background-color:#f4f1de;">= é é‡‘æŒ¯æ›¿ =</th>
                </tr>
                <colgroup>
                    <col class="name-col">
                    <col class="date-col">
                    <col class="number-col">
                    <col class="ammount-col">
                    <col class="connect-col">
                </colgroup>                
                <tr class="blue2-highlight">
                    <th>ç›¸æ‰‹å…ˆ</th>
                    <th>æ—¥ä»˜</th>
                    <th>ç•ªå·</th>
                    <th>è¦‹è¾¼/å®Ÿéš›</th>
                    <th>é€£çµ</th>
                </tr>

                <!-- æœªé€£æº(connected_numberãªã—)ãƒ‡ãƒ¼ã‚¿ -->
                <tbody id="fundtrans_items_{{ dr.id }}"
                       ondrop="drop(event, '{{ dr.id }}', 'fundtrans')"
                       ondragover="allowDrop(event)">
                    <!-- æ–°è¦ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ç”¨ -->
                    <tr>
                        <td colspan="5" style="text-align:center; background-color:#fdfcf3;">
                            é é‡‘æŒ¯æ›¿ã€€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        </td>
                    </tr>
                    {% with unconnected_fundtrans=data.items.é é‡‘æŒ¯æ›¿ %}
                    {% for item in unconnected_fundtrans %}
                    {% if not item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no1_{{ item.id }}"
                                   value="{{ item.sort_no1 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="sort_no2_{{ item.id }}"
                                   value="{{ item.sort_no2 }}"
                                   style="width:50px;">
                        </td>
                        <td class="text-right">
                            <input type="number"
                                   name="amount_{{ item.id }}"
                                   value="{{ item.amount }}"
                                   class="text-right"
                                   style="width:150px;">
                        </td>
                        <td>
                            <button class="delete-button" type="button" onclick="deleteBudgetItem('{{ item.id }}')">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% endwith %}
                </tbody>
                <tr class="accordion-header" data-target="connected_fundtrans_{{ dr.id }}">
                    <td colspan="5" class="text-left" style="background-color:#f4f1de;">
                        é€£æºæ¸ˆãƒ‡ãƒ¼ã‚¿(é é‡‘æŒ¯æ›¿)
                        <span class="accordion-icon">â–¼</span>
                    </td>
                </tr>
                <tbody id="connected_fundtrans_{{ dr.id }}" class="hidden">
                    {% for item in data.items.é é‡‘æŒ¯æ›¿ %}
                    {% if item.connected_number %}
                    <tr>
                        <td class="text-left">{{ item.item_name }}</td>
                        <td>{{ item.sort_no1 }}</td>
                        <td>{{ item.sort_no2 }}</td>
                        <td class="text-right">{{ item.amount }}</td>
                        <td>
                            <button class="unlink-button" type="button" onclick="unlinkConnection('{{ item.connected_number }}')">è§£é™¤</button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
                <tr  style="background-color:#f4f1de;">
                    <td>=é é‡‘æŒ¯æ›¿åˆè¨ˆ=</td>
                    <td colspan="4" class="text-right">{{ data.fundtrans_total }}</td>
                </tr>



                <tr class="blue-highlight">
                    <td colspan="2">{{ dr.name }} æ®‹é«˜è¦‹è¾¼</td>
                    <td colspan="3" class="text-right">{{ data.new_balance }}</td>
                </tr>
                <tr class="blue-highlight">
                    <td colspan="5">
                        <!-- DateRangeã”ã¨ã«æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ (å…¥é‡‘/è‡ªå‹•å¼•è½/å€‹åˆ¥æ”¯æ‰•) -->
                        <button
                            type="button"
                            class="add-button"
                            onclick="addBudgetItem('insales', '{{ dr.id }}', '{{ year_month }}')">
                            å·¥äº‹é‡‘å…¥é‡‘ æ–°è¦è¿½åŠ 
                        </button>
    
                        <button
                            type="button"
                            class="add-button"
                            onclick="addBudgetItem('inregular', '{{ dr.id }}', '{{ year_month }}')">
                            ãã®ä»–å…¥é‡‘ æ–°è¦è¿½åŠ 
                        </button>
    
                        <button
                            type="button"
                            class="add-button"
                            onclick="addBudgetItem('auto', '{{ dr.id }}', '{{ year_month }}')">
                            è‡ªå‹•å¼•è½ æ–°è¦è¿½åŠ 
                        </button>
    
                        <button
                            type="button"
                            class="add-button"
                            onclick="addBudgetItem('individual', '{{ dr.id }}', '{{ year_month }}')">
                            å€‹åˆ¥æ”¯æ‰• æ–°è¦è¿½åŠ 
                        </button>
                    </td>
                </tr>
            </table>

            <table>
                <tr>
                    <td colspan="2">{{ dr.name }} æ®‹é«˜è¦‹è¾¼</td>
                    <td colspan="3"  class="text-right">{{ data.new_balance }}</td>
                </tr>
            </table>
            <hr>
            {% endfor %}

            <!-- å…¨ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬ã§ä¿å­˜ãƒœã‚¿ãƒ³ -->
            <button type="submit">ä¿å­˜</button>
        </form>
    </div>


    <div class="mini-table-container">
        <h3>é€£çµ</h3>
        <table>
            <tr><th>é€£çµ</th></tr>
            <tr><td>&nbsp;</td></tr>
        </table>
    </div>


    <!-- å³ã‚«ãƒ©ãƒ  (éŠ€è¡Œãƒ‡ãƒ¼ã‚¿) -->
    <div class="scrollable scrollable-right">
        <h3>éŠ€è¡Œãƒ‡ãƒ¼ã‚¿</h3>
        <!-- å…¥é‡‘ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º -->
        <h3>å…¥é‡‘</h3>
        <table>
            <tr>
                <th>æ—¥ä»˜</th>
                <th>é …ç›®</th>
                <th>é‡‘é¡</th>
                <th>æ“ä½œ</th>
            </tr>
            {% for bank in bank_data %}
                {% if bank.transaction_type == "å…¥é‡‘" and bank.account_code and selected_account_code and bank.account_code.id == selected_account_code.id %}
                <tr draggable="true" ondragstart="dragStart(event)" data-id="{{ bank.bank_id }}"  data-name="{{ bank.item_name }}" data-amount="{{ bank.amount }}" data-transaction-type="{{ bank.transaction_type }}" data-connected_number="{{ bank.connected_number|default_if_none:'' }}" data-date="{{ bank.date|date:'Y-m-d' }}">
                    <td>{{ bank.date|date:"Y-m-d" }} {{ bank.transaction_type }}</td>
                    <td>{{ bank.item_name }}</td>
                    <td>{{ bank.amount }}</td>
                    <td>
                        {% if bank.connected_number %}
                            <button class="unlink-button" onclick="unlinkConnection('{{ bank.connected_number }}')">é€£çµè§£é™¤</button>
                        {% else %}
                        Â 
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </table>

        <!-- å‡ºé‡‘ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º -->
        <h3>å‡ºé‡‘</h3>
        <table>
            <tr>
                <th>æ—¥ä»˜</th>
                <th>é …ç›®</th>
                <th>é‡‘é¡</th>
                <th>æ“ä½œ</th>
            </tr>
            {% for bank in bank_data %}
                {% if bank.transaction_type == "å‡ºé‡‘" and bank.account_code and selected_account_code and bank.account_code.id == selected_account_code.id %}
                <tr draggable="true" ondragstart="dragStart(event)" data-id="{{ bank.bank_id }}"  data-name="{{ bank.item_name }}" data-amount="{{ bank.amount }}" data-transaction-type="{{ bank.transaction_type }}" data-connected_number="{{ bank.connected_number|default_if_none:'' }}" data-date="{{ bank.date|date:'Y-m-d' }}">
                    <td>{{ bank.date|date:"Y-m-d" }} {{ bank.transaction_type }}</td>
                    <td>{{ bank.item_name }}</td>
                    <td>{{ bank.amount }}</td>
                    <td>
                        {% if bank.connected_number %}
                            <button class="unlink-button" onclick="unlinkConnection('{{ bank.connected_number }}')">é€£çµè§£é™¤</button>
                        {% else %}
                            Â 
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </table>
    </div>
</div>

<script>
/* CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾— */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—é–‹å§‹æ™‚ */
function dragStart(event) {
    const row = event.currentTarget;
    const transactionType = row.dataset.transactionType || "å‡ºé‡‘";

    // ãƒ‡ãƒãƒƒã‚°: data-date ã®ç¢ºèª
    console.log("ğŸ” row.dataset:", row.dataset);
    console.log("ğŸ“… å–å¾—ã—ãŸ data-date:", row.dataset.date); // ã“ã“ã§å€¤ã‚’ç¢ºèª

    // æ—¥ä»˜ã‚’å–å¾—ã—ã¦æ—¥ï¼ˆdayï¼‰ã®ã¿ã‚’æŠ½å‡º
    const fullDate = row.dataset.date || ""; // ä¾‹: "2025-02-25"
    const dateParts = fullDate.split("-"); // ["2025", "02", "25"]
    const day_num = dateParts.length === 3 ? dateParts[2] : ""; // "25" ã‚’å–å¾—

    console.log("ğŸ“† å–å¾—ã—ãŸ fullDate:", fullDate);
    console.log("ğŸ“… æŠ½å‡ºã—ãŸ day_num:", day_num);

    event.dataTransfer.setData("id", row.dataset.id);
    event.dataTransfer.setData("name", row.dataset.name);
    event.dataTransfer.setData("amount", row.dataset.amount);
    event.dataTransfer.setData("transaction_type", transactionType);
    event.dataTransfer.setData("connected_number", row.dataset.connected_number || "");
    event.dataTransfer.setData("day_num", day_num);
}


/* ãƒ‰ãƒ­ãƒƒãƒ—å…ˆãŒå—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
function allowDrop(event) {
    event.preventDefault();
}

/**
 * ãƒ‰ãƒ­ãƒƒãƒ—ç›´å¾Œã«Ajaxã‚’æŠ•ã’ã¦éŠ€è¡Œãƒ‡ãƒ¼ã‚¿ã¨ã®é€£æºã¾ã§è¡Œã†
 */
function drop(event, dateRangeId, itemType) {
    event.preventDefault();
    const itemId = event.dataTransfer.getData("id");
    const itemName = event.dataTransfer.getData("name");
    let amount = event.dataTransfer.getData("amount");
    const transactionType = event.dataTransfer.getData("transaction_type") || "å‡ºé‡‘";
    const connected_number = event.dataTransfer.getData("connected_number");
    const day_num = event.dataTransfer.getData("day_num");

    // æ—¢ã«é€£çµã•ã‚Œã¦ã„ã‚‹éŠ€è¡Œãƒ‡ãƒ¼ã‚¿ãªã‚‰ã‚¨ãƒ©ãƒ¼
    if (connected_number && connected_number !== "None" && connected_number !== "") {
        alert(`ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«é€£çµã•ã‚Œã¦ã„ã¾ã™ï¼ˆç•ªå·:${connected_number}ï¼‰ã€‚`);
        return;
    }

    // å…¥é‡‘ãƒ»å‡ºé‡‘ã®ç¨®åˆ¥ãŒæ­£ã—ã„ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã‹ç¢ºèª
    const isValidDrop = (transactionType === "å…¥é‡‘" && (itemType === "insales" || itemType === "inregular" || itemType === "fundtrans"))
                 || (transactionType === "å‡ºé‡‘" && (itemType === "auto" || itemType === "individual" || itemType === "fundtrans"));

    if (!isValidDrop) {
        alert(`ã“ã®å–å¼•ã¯è¿½åŠ ã§ãã¾ã›ã‚“ã€‚(å–å¼•ç¨®åˆ¥: ${transactionType})`);
        return;
    }

    // é é‡‘æŒ¯æ›¿ã§ã®å‡ºé‡‘ã®å ´åˆã¯é‡‘é¡ã‚’ãƒã‚¤ãƒŠã‚¹ã«ã™ã‚‹
    const withdrawal = (transactionType === "å‡ºé‡‘" && itemType === "fundtrans");
    if (withdrawal) {
        amount = Number(amount) * -1;
    }

    // ç”»é¢ä¸Šã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚è¡Œã‚’è¿½åŠ ã—ã¦è¦‹ãŸç›®ã‚’æ›´æ–°ï¼ˆæš«å®šï¼‰
    const tbody = document.getElementById(`${itemType}_items_${dateRangeId}`);
    if (tbody) {
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
            <td class="text-left">${itemName}</td>
            <td>${day_num}</td>
            <td>0</td>
            <td class="text-right"><input type="number" value="${amount}" class="text-right"></td>
            <td></td>
        `;
    }

    // Ajaxã§ã‚µãƒ¼ãƒãƒ¼ã¸é€£æºä¾é ¼
    fetch("{% url 'addbudget_item' %}", {
        method: "POST",
        credentials: "same-origin",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
            from_dragdrop: true,
            item_id: itemId,         // BankDataã®ä¸»ã‚­ãƒ¼
            bank_id: itemId,         // åŒã˜ã bank_id ã¨ã—ã¦ä½¿ã†
            item_name: itemName,
            amount: amount,
            day_num:day_num,
            transaction_type: transactionType,
            daterange_id: dateRangeId,
            itemtype: itemType,      // "income" / "auto" / "individual"
            year_month: "{{ year_month }}",
            account_code_id: "{{ selected_account_code.id|default_if_none:'' }}"
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            console.log("é€£æºæˆåŠŸ:", data.message);
            // Ajaxé€šä¿¡æˆåŠŸ -> ã“ã“ã§æ‰‹å‹•ãƒªãƒ­ãƒ¼ãƒ‰
            window.location.reload(); 
        } else {
            console.error("é€£æºã‚¨ãƒ©ãƒ¼:", data.message);
            alert("é€£æºã‚¨ãƒ©ãƒ¼: " + data.message);
        }
    })
    .catch(error => console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", error));
}

/* æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆç”»é¢ã«è¡Œã‚’è¿½åŠ ã™ã‚‹ã ã‘ãƒ»ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã¯ä¿å­˜ãƒœã‚¿ãƒ³æ™‚ï¼‰ */
function addBudgetItem(itemType, dateRangeId, yearMonth) {
    let tbodyId;
    let itemTypeValue;

    if (itemType === 'insales') {
        tbodyId = 'insales_items_' + dateRangeId;
        itemTypeValue = "å·¥äº‹é‡‘å…¥é‡‘";
    } else if (itemType === 'inregular') {
        tbodyId = 'inregular_items_' + dateRangeId;
        itemTypeValue = "ãã®ä»–å…¥é‡‘";
    } else if (itemType === 'auto') {
        tbodyId = 'auto_items_' + dateRangeId;
        itemTypeValue = "è‡ªå‹•å¼•è½";
    } else if (itemType === 'individual') {
        tbodyId = 'individual_items_' + dateRangeId;
        itemTypeValue = "å€‹åˆ¥æ”¯æ‰•";

    } else if (itemType === 'fundtrans') {
        tbodyId = 'fundtrans_items_' + dateRangeId;
        itemTypeValue = "é é‡‘æŒ¯æ›¿";
    }

    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;

    const newRow = tbody.insertRow();
    const prefix = dateRangeId + '_' + itemType + '_new';
    newRow.innerHTML = `
        <td><input type="text" name="item_name_${prefix}" placeholder="ç›¸æ‰‹å…ˆ"></td>
        <td><input type="number" name="sort_no1_${prefix}" value="0" style="width:50px;"></td>
        <td><input type="number" name="sort_no2_${prefix}" value="0" style="width:50px;"></td>
        <td><input type="number" name="amount_${prefix}" value="0" class="text-right"></td>
        <td></td>
        <td></td>

        <input type="hidden" name="itemtype_${prefix}" value="${itemTypeValue}">
        <input type="hidden" name="daterange_${prefix}" value="${dateRangeId}">
        <input type="hidden" name="year_month_${prefix}" value="${yearMonth}">
        <input type="hidden" name="actual_${prefix}" value="False">
    `;
}




function unlinkConnection(connectedNumber) {
    //if (!confirm("æœ¬å½“ã«é€£çµã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
    //    return;
    //}

    fetch("{% url 'unlink_connection' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({ connected_number: connectedNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            //alert("é€£çµã‚’è§£é™¤ã—ã¾ã—ãŸ");
            window.location.reload(); // F5ã¨åŒã˜æŒ™å‹•
        } else {
            alert("é€£çµè§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + data.message);
        }
    })
    .catch(error => console.error("ã‚¨ãƒ©ãƒ¼:", error));
}

function deleteBudgetItem(budgetId) {
    if (!confirm("ã“ã®äºˆç®—é …ç›®ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
        return;
    }

    fetch("{% url 'delete_budget_item' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({ budget_id: budgetId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            window.location.reload();
        } else {
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + data.message);
        }
    })
    .catch(error => console.error("ã‚¨ãƒ©ãƒ¼:", error));
}

//-----------------------------------------------
/* å€‹åˆ¥ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ï¼ˆã‚¯ãƒªãƒƒã‚¯å¯¾å¿œï¼‰ */
//-----------------------------------------------

function toggleAccordion(elementId) {
    const elem = document.getElementById(elementId);
    if (!elem) return;

    // é–‹é–‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
    elem.classList.toggle('hidden');

    // å¯¾å¿œã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ï¼ˆ.accordion-headerï¼‰ã‚’æ¢ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    const header = document.querySelector(`.accordion-header[data-target="${elementId}"]`);
    if (header) {
        const icon = header.querySelector('.accordion-icon');
        if (icon) {
            // é–‹ã„ã¦ã„ã‚Œã° 'â–²'ã€é–‰ã˜ã¦ã„ã‚Œã° 'â–¼'
            icon.textContent = elem.classList.contains('hidden') ? 'â–¼' : 'â–²';
        }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    const accordions = JSON.parse(localStorage.getItem('accordions')) || {};
    // true => é–‹ã„ã¦ã„ã‚‹ã€false => é–‰ã˜ã¦ã„ã‚‹
    accordions[elementId] = !elem.classList.contains('hidden');
    localStorage.setItem('accordions', JSON.stringify(accordions));
}

/* ã™ã¹ã¦ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã */
function openAllAccordions() {
    // é–‹é–‰å¯¾è±¡ã¨ãªã‚‹è¦ç´ ã‚’ä¸€æ‹¬å–å¾— (ä¾‹: tbody, table)
    document.querySelectorAll('tbody.hidden, table.hidden').forEach(element => {
        // hiddenã‚¯ãƒ©ã‚¹ã‚’å¤–ã™ => å…¨éƒ¨é–‹ã
        element.classList.remove('hidden');

        // data-target="element.id" ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¢ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’â–²ã«
        const header = document.querySelector(`.accordion-header[data-target="${element.id}"]`);
        if (header) {
            const icon = header.querySelector('.accordion-icon');
            if (icon) icon.textContent = 'â–²';
        }
    });
    saveAllAccordionState(true);
}

/* ã™ã¹ã¦ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã‚‹ */
function closeAllAccordions() {
    document.querySelectorAll('tbody, table').forEach(element => {
        // hiddenã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘ã‚‹ => å…¨éƒ¨é–‰ã˜ã‚‹
        element.classList.add('hidden');

        // data-target="element.id" ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¢ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’â–¼ã«
        const header = document.querySelector(`.accordion-header[data-target="${element.id}"]`);
        if (header) {
            const icon = header.querySelector('.accordion-icon');
            if (icon) icon.textContent = 'â–¼';
        }
    });
    saveAllAccordionState(false);
}

/* ã™ã¹ã¦ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³çŠ¶æ…‹ã‚’ä¿å­˜ */
function saveAllAccordionState(isOpen) {
    const accordions = {};
    document.querySelectorAll('tbody, table').forEach(element => {
        // isOpen = true ãªã‚‰ã™ã¹ã¦é–‹ãã€false ãªã‚‰ã™ã¹ã¦é–‰ã˜ã‚‹
        accordions[element.id] = isOpen;
    });
    localStorage.setItem('accordions', JSON.stringify(accordions));
}


//----------------------------------------------------------------------------------------------
/*1.ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰å‡¦ç†å®Ÿè¡Œ
  2.ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å¾©å…ƒ
  3.æŒ¯æ›¿å‡¦ç†ãƒã‚§ãƒƒã‚¯ï¼ˆå…¥å‡ºé‡‘é¡ãŒåŒä¸€é‡‘é¡ã«ãªã£ã¦ã„ã‚‹ã‹ï¼‰
*/
//----------------------------------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {
    // 1) ã¾ãšã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®é–‹é–‰çŠ¶æ…‹ã‚’å¾©å…ƒ
    const accordions = JSON.parse(localStorage.getItem('accordions')) || {};
    document.querySelectorAll('tbody, table').forEach(element => {
        if (accordions[element.id] !== undefined) {
            const shouldOpen = accordions[element.id];
            element.classList.toggle('hidden', !shouldOpen);
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ¢ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³åæ˜ 
            const header = document.querySelector(`.accordion-header[data-target="${element.id}"]`);
            if (header) {
                const icon = header.querySelector('.accordion-icon');
                if (icon) icon.textContent = shouldOpen ? 'â–²' : 'â–¼';
            }
        }
    });

    // 2) ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function () {
            const targetId = header.getAttribute('data-target');
            toggleAccordion(targetId);
        });
    });

    // 3) å·¦å´ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®å¾©å…ƒ
    const scrollableLeft = document.querySelector('.scrollable-left');
    if (scrollableLeft) {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ•°å€¤ã‚’å–ã‚Šå‡ºã™
        const savedLeftPos = localStorage.getItem("scrollLeftPos");
        if (savedLeftPos !== null) {
            console.log("ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ:", savedLeftPos);
            scrollableLeft.scrollTop = parseInt(savedLeftPos, 10);
        }
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ãŸã³ã«ä½ç½®ã‚’ä¿å­˜
        scrollableLeft.addEventListener("scroll", function() {
            localStorage.setItem("scrollLeftPos", scrollableLeft.scrollTop);
        });
    }

    // 4) éš ã—è¦ç´  amount_fundtrans ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆ
    const amount = document.getElementById("amount_fundtrans").value;
    if (amount !== "0") {
        //alert("æŒ¯æ›¿ã®åˆè¨ˆãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ï¼");
    }
});


</script>
</body>
</html>
